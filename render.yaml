# render.yaml (at repo root)
# Deploys: Postgres DB, Node/Express API, Vite static site
# Security: Uses pinned Node.js versions and security best practices

services:
  # --- API (Express) ---
  - type: web
    name: ai-survey-api
    runtime: node
    plan: free
    rootDir: api
    buildCommand: npm ci
    startCommand: npm start
    healthCheckPath: /health
    envVars:
      - key: DATABASE_URL
        fromDatabase:
          name: ai-survey-db
          property: connectionString
      - key: NODE_VERSION
        value: 20.11.1  # Pinned LTS version for security
      - key: NODE_ENV
        value: production
      - key: JWT_SECRET
        generateValue: true
      # Security: Encryption and KMS configuration
      - key: ENCRYPTION_KEY
        generateValue: true
      - key: AWS_REGION
        value: us-east-1
      - key: KMS_KEY_ID
        sync: false
      - key: AWS_ACCESS_KEY_ID
        sync: false
      - key: AWS_SECRET_ACCESS_KEY
        sync: false
      # Budget and monitoring
      - key: AI_LOG_RETENTION_DAYS
        value: 90
      - key: AI_DEFAULT_MODEL
        value: gpt-4o-mini
      # Optional: to tighten CORS once you know your web URL
      - key: CLIENT_ORIGIN
        sync: false
      # Add your other environment variables here
      # - key: OPENAI_API_KEY
      #   value: your-openai-key
      # - key: SENDGRID_API_KEY
      #   value: your-sendgrid-key
      # - key: AUTH0_SECRET
      #   generateValue: true
      # - key: AUTH0_BASE_URL
      #   fromService:
      #     type: web
      #     name: ai-survey-web
      #     property: host
      # - key: AUTH0_ISSUER_BASE_URL
      #   value: your-auth0-domain
      # - key: AUTH0_CLIENT_ID
      #   value: your-auth0-client-id
      # - key: AUTH0_CLIENT_SECRET
      #   value: your-auth0-client-secret
    buildFilter:
      paths:
        - api/**

  # --- Web (Vite React) ---
  - type: web
    name: ai-survey-web
    runtime: static
    rootDir: web
    buildCommand: npm ci && npm run build
    staticPublishPath: ./dist
    # SPA rewrite so deep links hit index.html
    routes:
      - type: rewrite
        source: /*
        destination: /index.html
      # Optional proxy so the client can call /api/* without CORS:
      # After the first deploy, replace <API_URL> with ai-survey-api's public URL
      # - type: rewrite
      #   source: /api/*
      #   destination: https://<API_URL>/*
    envVars:
      # If you're not using the /api/* proxy, set the API base URL:
      - key: VITE_API_URL
        sync: false
      # Security: Pin Node.js version
      - key: NODE_VERSION
        value: 20.11.1  # Pinned LTS version for security
    buildFilter:
      paths:
        - web/**

databases:
  - name: ai-survey-db
    plan: free
    # Security: Enable SSL and connection limits
    # Note: Render automatically provides SSL for production databases
